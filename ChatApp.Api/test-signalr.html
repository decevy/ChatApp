<!DOCTYPE html>
<html>
<head>
    <title>SignalR Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
</head>
<body>
    <h2>SignalR Chat Test</h2>
    <div>
        <input type="text" id="token" placeholder="JWT Token" style="width: 400px;"/>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    <div>
        <input type="number" id="roomId" placeholder="Room ID" value="1"/>
        <button onclick="joinRoom()">Join Room</button>
        <button onclick="leaveRoom()">Leave Room</button>
    </div>
    <div>
        <input type="text" id="message" placeholder="Message" style="width: 300px;"/>
        <button onclick="sendMessage()">Send</button>
        <button onclick="startTyping()">Start Typing</button>
        <button onclick="stopTyping()">Stop Typing</button>
    </div>
    <h3>Messages:</h3>
    <div id="messages" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px;"></div>

    <script>
        let connection;

        function connect() {
            const token = document.getElementById('token').value;
            
            if (!token) {
                addMessage("ERROR: Please enter a JWT token first!");
                return;
            }

            addMessage("Attempting to connect...");
            
            connection = new signalR.HubConnectionBuilder()
                .withUrl("http://localhost:5056/chatHub", { 
                    accessTokenFactory: () => token,
                    skipNegotiation: false  // Explicitly enable negotiation
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Debug)  // Enable debug logging
                .build();

            // Event handlers
            connection.on("ReceiveMessage", (data) => {
                addMessage(`[${data.createdAt}] ${data.user.username}: ${data.content}`);
            });

            connection.on("UserJoinedRoom", (data) => {
                addMessage(`${data.username} joined room ${data.roomId}`);
            });

            connection.on("UserLeftRoom", (data) => {
                addMessage(`${data.username} left room ${data.roomId}`);
            });

            connection.on("UserStartedTyping", (data) => {
                addMessage(`${data.username} is typing...`);
            });

            connection.on("UserStoppedTyping", (data) => {
                addMessage(`${data.username} stopped typing`);
            });

            connection.on("UserStatusChanged", (data) => {
                addMessage(`User ${data.userId} is ${data.isOnline ? 'online' : 'offline'}`);
            });

            connection.on("MessageEdited", (data) => {
                addMessage(`Message ${data.id} edited: ${data.content}`);
            });

            connection.on("MessageDeleted", (data) => {
                addMessage(`Message ${data.id} deleted`);
            });

            connection.start()
                .then(() => {
                    addMessage("✅ Connected successfully!");
                    console.log("SignalR Connected");
                })
                .catch(err => {
                    addMessage(`❌ Connection Error: ${err.message}`);
                    console.error("SignalR Error:", err);
                });

            connection.onclose((error) => {
                addMessage("Connection closed");
                if (error) {
                    console.error("Close error:", error);
                }
            });
        }

        function disconnect() {
            if (connection) {
                connection.stop();
                addMessage("Disconnected");
            }
        }

        function joinRoom() {
            const roomId = parseInt(document.getElementById('roomId').value);
            connection.invoke("JoinRoom", roomId)
                .then(() => addMessage(`✅ Joined room ${roomId}`))
                .catch(err => addMessage(`❌ Error joining room: ${err}`));
        }

        function leaveRoom() {
            const roomId = parseInt(document.getElementById('roomId').value);
            connection.invoke("LeaveRoom", roomId)
                .then(() => addMessage(`Left room ${roomId}`))
                .catch(err => addMessage(`❌ Error leaving room: ${err}`));
        }

        function sendMessage() {
            const roomId = parseInt(document.getElementById('roomId').value);
            const message = document.getElementById('message').value;
            
            if (!message) {
                addMessage("ERROR: Please enter a message");
                return;
            }
            
            connection.invoke("SendMessage", roomId, message)
                .then(() => {
                    document.getElementById('message').value = '';
                    addMessage("✅ Message sent");
                })
                .catch(err => addMessage(`❌ Error: ${err}`));
        }

        function startTyping() {
            const roomId = parseInt(document.getElementById('roomId').value);
            connection.invoke("StartTyping", roomId)
                .catch(err => addMessage(`❌ Error: ${err}`));
        }

        function stopTyping() {
            const roomId = parseInt(document.getElementById('roomId').value);
            connection.invoke("StopTyping", roomId)
                .catch(err => addMessage(`❌ Error: ${err}`));
        }

        function addMessage(msg) {
            const div = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML += `<div>[${timestamp}] ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        // Debug: Log when page loads
        window.addEventListener('load', () => {
            addMessage("Page loaded. Enter JWT token and click Connect.");
        });
    </script>
</body>
</html>